# å·¥ä½œæµåç§°
name: Build OpenWrt x86_64 Mini

# è§¦å‘æ¡ä»¶ï¼špushåˆ°mainåˆ†æ”¯ / æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

# ä½œä¸šé…ç½®
jobs:
  build-openwrt:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      # æ­¥éª¤0ï¼šä¼˜å…ˆæ·±åº¦æ¸…ç†ç£ç›˜ï¼ˆè§£å†³No space lefté—®é¢˜ï¼Œç§»åˆ°æœ€å‰é¢ï¼‰
      - name: Deep Clean Disk Space (Critical!)
        run: |
          # 1. å¸è½½å¹¶åˆ é™¤è¶…å¤§æ— ç”¨åŒ…
          sudo apt remove -y --purge azure-cli* dotnet* ghc* google* llvm* mono* msodbcsql* mssql-tools* powershell* zulu* || true
          sudo apt autoremove -y --purge || true
          sudo apt clean || true
          
          # 2. åˆ é™¤è¶…å¤§ç›®å½•ï¼ˆé‡Šæ”¾10GB+ç©ºé—´ï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/lib/jvm /var/lib/docker || true
          sudo rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/* || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          
          # 3. æ¸…ç†æ—¥å¿—å’Œç¼“å­˜
          sudo journalctl --vacuum-size=100M || true
          sudo truncate -s 0 /var/log/*log || true
          
          # 4. æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼ˆä¾¿äºæ’æŸ¥ï¼‰
          df -h

      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šä¼˜åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆè¡¥å……æ¸…ç†ï¼‰
      - name: Optimize Build Environment
        uses: sclsyin/maximize-build-space@master
        with:
          root-reserve-mb: 2048  # é™ä½æ ¹ç›®å½•ä¿ç•™ç©ºé—´
          swap-size-mb: 8192
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true  # å¼ºåˆ¶åˆ é™¤æ‰€æœ‰Dockeré•œåƒ

      # æ­¥éª¤3ï¼šåˆå§‹åŒ–ç³»ç»Ÿä¾èµ–ï¼ˆç²¾ç®€ä¾èµ–åˆ—è¡¨+åˆ†æ­¥éª¤æ‰§è¡Œï¼‰
      - name: Install System Dependencies (Simplified)
        run: |
          # å…ˆæ›´æ–°ï¼ˆä»…æ›´æ–°å¿…è¦æºï¼Œè·³è¿‡è¶…å¤§åŒ…ï¼‰
          sudo apt update -o Acquire::http::No-Cache=True -o Acquire::http::Pipeline-Depth=0
          
          # åˆ†æ‰¹æ¬¡å®‰è£…ä¾èµ–ï¼Œé¿å…ä¸€æ¬¡æ€§å ç”¨è¿‡å¤šç©ºé—´
          sudo apt install -y build-essential flex bison g++ gawk gcc-multilib g++-multilib gettext git || true
          sudo apt install -y libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget || true
          sudo apt install -y libelf-dev libtool autopoint make libglib2.0-dev pkg-config curl zstd clang || true
          
          # å†æ¬¡æ¸…ç†
          sudo apt autoremove -y && sudo apt clean -y
          docker rmi $(docker images -q) || true
          df -h  # å†æ¬¡æŸ¥çœ‹ç£ç›˜ä½¿ç”¨

      # æ­¥éª¤4ï¼šå…‹éš†OpenWrtæºç 
      - name: Clone OpenWrt Source Code
        env:
          REPO_URL: https://github.com/openwrt/openwrt
          REPO_BRANCH: openwrt-23.05
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

      # æ­¥éª¤5ï¼šæ›´æ–°å¹¶å®‰è£…feeds
      - name: Update & Install Feeds
        run: |
          cd $OPENWRT_PATH
          sed -i 's/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g' feeds.conf.default
          ./scripts/feeds update -a || (sleep 10 && ./scripts/feeds update -a)
          ./scripts/feeds install -a

      # æ­¥éª¤6ï¼šå¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
      - name: Load Custom Configuration
        run: |
          cd $OPENWRT_PATH
          cp $GITHUB_WORKSPACE/configs/x86_64_Mini.config .config || {
            echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼"
            make defconfig
          }
          make defconfig

      # æ­¥éª¤7ï¼šä¸‹è½½ç¼–è¯‘ä¾èµ–
      - name: Download Dependencies
        run: |
          cd $OPENWRT_PATH
          make download -j8
          find dl -size -1024c -exec rm -f {} \; || true

      # æ­¥éª¤8ï¼šç¼–è¯‘å›ºä»¶
      - name: Compile OpenWrt Firmware
        id: compile
        continue-on-error: true
        run: |
          cd $OPENWRT_PATH
          COMPILE_THREAD=$(($(nproc)/2))
          if [ $COMPILE_THREAD -lt 1 ]; then COMPILE_THREAD=1; fi
          echo "Using $COMPILE_THREAD threads to compile..."
          make -j$COMPILE_THREAD || make -j1 V=s 2>&1 | tee build_error.log
          if [ -f "bin/targets/x86/64/*.img.gz" ] || [ -f "bin/targets/x86/64/*.tar.gz" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          echo "FIRMWARE_TAG=$(date +%Y%m%d)-x86_64-mini" >> $GITHUB_ENV

      # æ­¥éª¤9ï¼šä¸Šä¼ é”™è¯¯æ—¥å¿—
      - name: Upload Error Logs
        if: steps.compile.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-errors-logs
          path: |
            ${{ env.OPENWRT_PATH }}/build_error.log
            ${{ env.OPENWRT_PATH }}/.config
            ${{ env.OPENWRT_PATH }}/logs/
          retention-days: 7

      # æ­¥éª¤10ï¼šä¸Šä¼ å›ºä»¶
      - name: Upload Firmware Artifact
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86_64-mini-firmware
          path: ${{ env.OPENWRT_PATH }}/bin/targets/
          retention-days: 30

      # æ­¥éª¤11ï¼šå‘å¸ƒå›ºä»¶
      - name: Release Firmware
        if: steps.compile.outcome == 'success'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.FIRMWARE_TAG }}
          name: OpenWrt x86_64 Mini ${{ env.FIRMWARE_TAG }}
          body: |
            ğŸš€ OpenWrt x86_64 Mini å›ºä»¶ç¼–è¯‘å®Œæˆ
            - ç¼–è¯‘æ—¶é—´ï¼š${{ env.FIRMWARE_TAG }}
            - å¹³å°ï¼šx86_64
            - æ ¸å¿ƒæ’ä»¶ï¼šPassWall2ã€OpenClashã€AdGuardHomeã€TurboACC
          artifacts: ${{ env.OPENWRT_PATH }}/bin/targets/**/*.tar.gz,${{ env.OPENWRT_PATH }}/bin/targets/**/*.img.gz
          allowUpdates: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

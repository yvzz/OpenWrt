# å·¥ä½œæµåç§°
name: Build OpenWrt x86_64 Mini

# è§¦å‘æ¡ä»¶ï¼špushåˆ°mainåˆ†æ”¯ / æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

# ä½œä¸šé…ç½®
jobs:
  build-openwrt:
    runs-on: ubuntu-22.04  # ä½¿ç”¨Ubuntu 22.04ç¯å¢ƒï¼ˆOpenWrtç¼–è¯‘æ¨èï¼‰
    permissions:
      contents: write  # æˆäºˆå‘å¸ƒå›ºä»¶çš„æƒé™

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆOpenWrtæºç /é…ç½®æ–‡ä»¶ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…feedsåŒæ­¥å¤±è´¥

      # æ­¥éª¤2ï¼šä¼˜åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆæ¸…ç†ç£ç›˜/å¢åŠ äº¤æ¢ç©ºé—´ï¼‰
      - name: Optimize Build Environment
        uses: sclsyin/maximize-build-space@master  # ä¿®æ­£ï¼šä½¿ç”¨masteråˆ†æ”¯ï¼ˆæ— æ­£å¼ç‰ˆæœ¬ï¼‰
        with:
          root-reserve-mb: 4096
          swap-size-mb: 8192  # 8GBäº¤æ¢ç©ºé—´ï¼Œé¿å…å†…å­˜ä¸è¶³
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      # æ­¥éª¤3ï¼šåˆå§‹åŒ–ç³»ç»Ÿä¾èµ–
      - name: Install System Dependencies
        run: |
          sudo apt update && sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev libtool autopoint make libglib2.0-dev pkg-config curl zstd
          # æ¸…ç†æ— ç”¨åŒ…ï¼Œé‡Šæ”¾ç©ºé—´
          sudo apt autoremove -y && sudo apt clean -y
          # ä¿®å¤Dockeré•œåƒæ¸…ç†å¯èƒ½çš„é”™è¯¯
          docker rmi $(docker images -q) || true

      # æ­¥éª¤4ï¼šå…‹éš†OpenWrtæºç ï¼ˆå¯æ›¿æ¢ä¸ºä½ éœ€è¦çš„åˆ†æ”¯/ä»“åº“ï¼‰
      - name: Clone OpenWrt Source Code
        env:
          REPO_URL: https://github.com/openwrt/openwrt
          REPO_BRANCH: openwrt-23.05  # ç¨³å®šç‰ˆåˆ†æ”¯
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          # è®¾ç½®ç¼–è¯‘ç›®å½•ç¯å¢ƒå˜é‡
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

      # æ­¥éª¤5ï¼šæ›´æ–°å¹¶å®‰è£…feedsï¼ˆè§£å†³æ’ä»¶ä¾èµ–ï¼‰
      - name: Update & Install Feeds
        run: |
          cd $OPENWRT_PATH
          # æ›¿æ¢å›½å†…æºï¼ŒåŠ é€Ÿä¸‹è½½ï¼ˆå¯é€‰ï¼‰
          sed -i 's/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g' feeds.conf.default
          # é‡è¯•æœºåˆ¶ï¼Œé¿å…ç½‘ç»œå¤±è´¥
          ./scripts/feeds update -a || (sleep 10 && ./scripts/feeds update -a)
          ./scripts/feeds install -a

      # æ­¥éª¤6ï¼šå¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼ˆå…³é”®ï¼æ›¿æ¢ä¸ºä½ çš„configè·¯å¾„ï¼‰
      - name: Load Custom Configuration
        run: |
          cd $OPENWRT_PATH
          # å¤åˆ¶ä½ ä»“åº“ä¸­çš„x86_64_Mini.configåˆ°OpenWrtç›®å½•
          cp $GITHUB_WORKSPACE/configs/x86_64_Mini.config .config || {
            echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼"
            make defconfig
          }
          # éªŒè¯å¹¶ç”Ÿæˆé»˜è®¤é…ç½®
          make defconfig

      # æ­¥éª¤7ï¼šä¸‹è½½ç¼–è¯‘ä¾èµ–ï¼ˆæå‰ä¸‹è½½ï¼Œé¿å…ç¼–è¯‘ä¸­æ–­ï¼‰
      - name: Download Dependencies
        run: |
          cd $OPENWRT_PATH
          make download -j8
          # æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶ï¼ˆå®¹é”™å¤„ç†ï¼‰
          find dl -size -1024c -exec rm -f {} \; || true

      # æ­¥éª¤8ï¼šç¼–è¯‘å›ºä»¶ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œå¸¦é”™è¯¯æ—¥å¿—ï¼‰
      - name: Compile OpenWrt Firmware
        id: compile
        continue-on-error: true  # å¤±è´¥åç»§ç»­æ‰§è¡Œï¼Œä¿å­˜æ—¥å¿—
        run: |
          cd $OPENWRT_PATH
          # é™åˆ¶çº¿ç¨‹æ•°ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼ˆå…³é”®ï¼ï¼‰
          COMPILE_THREAD=$(($(nproc)/2))
          if [ $COMPILE_THREAD -lt 1 ]; then COMPILE_THREAD=1; fi
          echo "Using $COMPILE_THREAD threads to compile..."
          # ç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡æ–°ç¼–è¯‘å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
          make -j$COMPILE_THREAD || make -j1 V=s 2>&1 | tee build_error.log
          # æ ‡è®°ç¼–è¯‘çŠ¶æ€
          if [ -f "bin/targets/x86/64/*.img.gz" ] || [ -f "bin/targets/x86/64/*.tar.gz" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          # è®¾ç½®å›ºä»¶ç‰ˆæœ¬ä¿¡æ¯
          echo "FIRMWARE_TAG=$(date +%Y%m%d)-x86_64-mini" >> $GITHUB_ENV

      # æ­¥éª¤9ï¼šä¸Šä¼ é”™è¯¯æ—¥å¿—ï¼ˆç¼–è¯‘å¤±è´¥æ—¶è§¦å‘ï¼‰
      - name: Upload Error Logs
        if: steps.compile.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-errors-logs
          path: |
            ${{ env.OPENWRT_PATH }}/build_error.log
            ${{ env.OPENWRT_PATH }}/.config
            ${{ env.OPENWRT_PATH }}/logs/
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©

      # æ­¥éª¤10ï¼šä¸Šä¼ ç¼–è¯‘æˆåŠŸçš„å›ºä»¶
      - name: Upload Firmware Artifact
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86_64-mini-firmware
          path: ${{ env.OPENWRT_PATH }}/bin/targets/
          retention-days: 30  # å›ºä»¶ä¿ç•™30å¤©

      # æ­¥éª¤11ï¼šå‘å¸ƒå›ºä»¶åˆ°GitHub Releaseï¼ˆå¯é€‰ï¼Œç¼–è¯‘æˆåŠŸæ—¶è§¦å‘ï¼‰
      - name: Release Firmware
        if: steps.compile.outcome == 'success'
        uses: ncipollo/release-action@v1  # ä¿®æ­£ï¼šä½¿ç”¨å®˜æ–¹æœ€æ–°çš„v1ç‰ˆæœ¬
        with:
          tag: ${{ env.FIRMWARE_TAG }}
          name: OpenWrt x86_64 Mini ${{ env.FIRMWARE_TAG }}
          body: |
            ğŸš€ OpenWrt x86_64 Mini å›ºä»¶ç¼–è¯‘å®Œæˆ
            - ç¼–è¯‘æ—¶é—´ï¼š${{ env.FIRMWARE_TAG }}
            - å¹³å°ï¼šx86_64
            - æ ¸å¿ƒæ’ä»¶ï¼šPassWall2ã€OpenClashã€AdGuardHomeã€TurboACC
          artifacts: ${{ env.OPENWRT_PATH }}/bin/targets/**/*.tar.gz,${{ env.OPENWRT_PATH }}/bin/targets/**/*.img.gz
          allowUpdates: true  # å…è®¸æ›´æ–°åŒæ ‡ç­¾çš„Release
          makeLatest: true    # æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
          token: ${{ secrets.GITHUB_TOKEN }}
